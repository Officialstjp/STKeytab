# CI Pipeline - Runs on every push and PR (GitHub-hosted)
name: CI

on:
  push:
    branches: [main]
    paths:
      - 'Public/**'
      - 'Private/**'
      - 'tests/**'
      - 'STKeytab.psm1'
      - 'STKeytab.psd1'
      - '.github/workflows/ci.yml'

  pull_request:
    branches: [main]
    paths:
      - 'Public/**'
      - 'Private/**'
      - 'tests/**'
      - 'STKeytab.psm1'
      - 'STKeytab.psd1'

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell modules
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted

          # Install Pester
          $pester = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [Version]'5.0.0' }
          if (-not $pester) {
              Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          }

          # Install PSScriptAnalyzer
          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
              Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          }

      - name: Run Pester tests
        shell: pwsh
        run: |
          Import-Module Pester -MinimumVersion 5.0.0
          Import-Module .\STKeytab.psd1 -Force

          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'TestResults.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'

          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
              throw "$($result.FailedCount) test(s) failed"
          }

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.xml
          retention-days: 7

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Import-Module PSScriptAnalyzer

          $analyzerParams = @{
              Path = @('Public', 'Private', 'STKeytab.psm1', 'STKeytab.psd1')
              Recurse = $true
              Severity = 'Error'  # Only fail on errors
          }

          if (Test-Path './CI/Test-Sign/PSScriptAnalyzerSettings.psd1') {
              $analyzerParams.Settings = './CI/Test-Sign/PSScriptAnalyzerSettings.psd1'
          }

          $results = Invoke-ScriptAnalyzer @analyzerParams

          if ($results) {
              $results | Format-Table ScriptName, Line, RuleName, Message -AutoSize
              throw "PSScriptAnalyzer found $($results.Count) error(s)"
          } else {
              Write-Host "âœ“ No PSScriptAnalyzer errors found" -ForegroundColor Green
          }

      - name: Verify module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path .\STKeytab.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          Write-Host "Functions: $($manifest.ExportedFunctions.Count)"
          Write-Host "Exported: $($manifest.ExportedFunctions.Keys -join ', ')"
