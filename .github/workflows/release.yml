# Release Pipeline - Manual trigger for PSGallery publishing
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.6.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  test-and-release:
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git safe directory
        shell: pwsh
        run: git config --global --add safe.directory $env:GITHUB_WORKSPACE

      - name: Setup and Test
        shell: pwsh
        run: |
          ./CI/Test-Sign.ps1 -Step Setup
          ./CI/Test-Sign.ps1 -Step Test

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: ./CI/Test-Sign.ps1 -Step Analyze

      - name: Verify module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path .\STKeytab.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          Write-Host "Functions: $($manifest.ExportedFunctions.Keys -join ', ')"

      - name: Update module version
        shell: pwsh
        run: |
          $manifestPath = '.\STKeytab.psd1'
          $content = Get-Content $manifestPath -Raw
          $content = $content -replace "ModuleVersion\s*=\s*'[^']*'", "ModuleVersion = '${{ inputs.version }}'"
          Set-Content $manifestPath -Value $content -NoNewline

      - name: Prepare module for publishing
        shell: pwsh
        run: |
          $publishDir = 'publish/STKeytab'
          New-Item -Path $publishDir -ItemType Directory -Force | Out-Null

          # Copy module files (exclude dev/test artifacts)
          Copy-Item -Path 'STKeytab.psd1' -Destination $publishDir
          Copy-Item -Path 'STKeytab.psm1' -Destination $publishDir
          Copy-Item -Path 'Public' -Destination $publishDir -Recurse
          Copy-Item -Path 'Private' -Destination $publishDir -Recurse
          Copy-Item -Path 'en-US' -Destination $publishDir -Recurse
          Copy-Item -Path 'LICENSE' -Destination $publishDir
          Copy-Item -Path 'NOTICE' -Destination $publishDir
          Copy-Item -Path 'README.md' -Destination $publishDir
          Copy-Item -Path 'CHANGELOG.md' -Destination $publishDir

          Write-Host "Package contents:"
          Get-ChildItem $publishDir -Recurse | Format-Table Name, Length

      - name: Publish to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          Install-Module PowerShellGet -Force -AllowClobber -Scope CurrentUser -ErrorAction SilentlyContinue
          Import-Module PowerShellGet -Force

          $publishDir = 'publish/STKeytab'
          Publish-Module -Path $publishDir -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose

      - name: Create ZIP for release
        shell: pwsh
        run: Compress-Archive -Path "publish/STKeytab/*" -DestinationPath "STKeytab-${{ inputs.version }}.zip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: STKeytab-${{ inputs.version }}
          path: publish/STKeytab/
          retention-days: 90

      - name: Build help artifacts
        shell: pwsh
        run: |
          # Install PlatyPS
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          if (-not (Get-Module PlatyPS -ListAvailable)) {
              Install-Module -Name PlatyPS -Scope CurrentUser -Force -AllowClobber
          }
          Import-Module PlatyPS -ErrorAction Stop

          # Build docs and CAB
          ./CI/Build-Docs.ps1 -Mode Update

          Write-Host "Help artifacts built:"
          Get-ChildItem artifacts/docs/ | ForEach-Object { Write-Host "  $($_.Name)" }

      - name: Publish help to stable release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create or update the stable 'help' release for Update-Help
          $helpTag = 'help'

          # Check if release exists
          $existing = gh release view $helpTag 2>$null
          if (-not $existing) {
              Write-Host "Creating stable help release..."
              gh release create $helpTag --title "Help Content" --notes "External help files for Update-Help support. Updated automatically on each release."
          }

          # Upload CAB and HelpInfo.xml (overwrite existing)
          Write-Host "Uploading help artifacts..."
          Get-ChildItem artifacts/docs/*.cab, artifacts/docs/*_HelpInfo.xml | ForEach-Object {
              Write-Host "  Uploading $($_.Name)..."
              gh release upload $helpTag $_.FullName --clobber
          }

          Write-Host "Help published! Users can run: Update-Help -Module STKeytab"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: STKeytab v${{ inputs.version }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            STKeytab-${{ inputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
